var e,t,n={},r={},o={};function a(){if(e)return o;e=1,Object.defineProperty(o,"__esModule",{value:!0}),o.ERROR_PACKET=o.PACKET_TYPES_REVERSE=o.PACKET_TYPES=void 0;const t=Object.create(null);o.PACKET_TYPES=t,t.open="0",t.close="1",t.ping="2",t.pong="3",t.message="4",t.upgrade="5",t.noop="6";const n=Object.create(null);o.PACKET_TYPES_REVERSE=n,Object.keys(t).forEach((e=>{n[t[e]]=e}));return o.ERROR_PACKET={type:"error",data:"parser error"},o}var c,f,i,u={},d={};function s(){if(f)return u;f=1,Object.defineProperty(u,"__esModule",{value:!0}),u.decodePacket=void 0;const e=a(),t=function(){if(c)return d;c=1,Object.defineProperty(d,"__esModule",{value:!0}),d.decode=d.encode=void 0;const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t="undefined"==typeof Uint8Array?[]:new Uint8Array(256);for(let n=0;n<64;n++)t[e.charCodeAt(n)]=n;return d.encode=t=>{let n,r=new Uint8Array(t),o=r.length,a="";for(n=0;n<o;n+=3)a+=e[r[n]>>2],a+=e[(3&r[n])<<4|r[n+1]>>4],a+=e[(15&r[n+1])<<2|r[n+2]>>6],a+=e[63&r[n+2]];return o%3==2?a=a.substring(0,a.length-1)+"=":o%3==1&&(a=a.substring(0,a.length-2)+"=="),a},d.decode=e=>{let n,r,o,a,c,f=.75*e.length,i=e.length,u=0;"="===e[e.length-1]&&(f--,"="===e[e.length-2]&&f--);const d=new ArrayBuffer(f),s=new Uint8Array(d);for(n=0;n<i;n+=4)r=t[e.charCodeAt(n)],o=t[e.charCodeAt(n+1)],a=t[e.charCodeAt(n+2)],c=t[e.charCodeAt(n+3)],s[u++]=r<<2|o>>4,s[u++]=(15&o)<<4|a>>2,s[u++]=(3&a)<<6|63&c;return d},d}(),n="function"==typeof ArrayBuffer;u.decodePacket=(t,n)=>{if("string"!=typeof t)return{type:"message",data:o(t,n)};const a=t.charAt(0);if("b"===a)return{type:"message",data:r(t.substring(1),n)};return e.PACKET_TYPES_REVERSE[a]?t.length>1?{type:e.PACKET_TYPES_REVERSE[a],data:t.substring(1)}:{type:e.PACKET_TYPES_REVERSE[a]}:e.ERROR_PACKET};const r=(e,r)=>{if(n){const n=(0,t.decode)(e);return o(n,r)}return{base64:!0,data:e}},o=(e,t)=>"blob"===t?e instanceof Blob?e:new Blob([e]):e instanceof ArrayBuffer?e:e.buffer;return u}function l(){return i||(i=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.decodePayload=e.decodePacket=e.encodePayload=e.encodePacket=e.protocol=void 0,e.createPacketEncoderStream=function(){return new TransformStream({transform(e,t){(0,n.encodePacketToBinary)(e,(n=>{const r=n.length;let o;if(r<126)o=new Uint8Array(1),new DataView(o.buffer).setUint8(0,r);else if(r<65536){o=new Uint8Array(3);const e=new DataView(o.buffer);e.setUint8(0,126),e.setUint16(1,r)}else{o=new Uint8Array(9);const e=new DataView(o.buffer);e.setUint8(0,127),e.setBigUint64(1,BigInt(r))}e.data&&"string"!=typeof e.data&&(o[0]|=128),t.enqueue(o),t.enqueue(n)}))}})},e.createPacketDecoderStream=function(e,t){i||(i=new TextDecoder);const n=[];let r=0,a=-1,f=!1;return new TransformStream({transform(s,l){for(n.push(s);;){if(0===r){if(u(n)<1)break;const e=d(n,1);f=!(128&~e[0]),a=127&e[0],r=a<126?3:126===a?1:2}else if(1===r){if(u(n)<2)break;const e=d(n,2);a=new DataView(e.buffer,e.byteOffset,e.length).getUint16(0),r=3}else if(2===r){if(u(n)<8)break;const e=d(n,8),t=new DataView(e.buffer,e.byteOffset,e.length),o=t.getUint32(0);if(o>Math.pow(2,21)-1){l.enqueue(c.ERROR_PACKET);break}a=o*Math.pow(2,32)+t.getUint32(4),r=3}else{if(u(n)<a)break;const e=d(n,a);l.enqueue((0,o.decodePacket)(f?e:i.decode(e),t)),r=0}if(0===a||a>e){l.enqueue(c.ERROR_PACKET);break}}}})};const n=function(){if(t)return r;t=1,Object.defineProperty(r,"__esModule",{value:!0}),r.encodePacket=void 0,r.encodePacketToBinary=function(e,t){return n&&e.data instanceof Blob?e.data.arrayBuffer().then(u).then(t):o&&(e.data instanceof ArrayBuffer||c(e.data))?t(u(e.data)):void f(e,!1,(e=>{d||(d=new TextEncoder),t(d.encode(e))}))};const e=a(),n="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),o="function"==typeof ArrayBuffer,c=e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer instanceof ArrayBuffer,f=({type:t,data:r},a,f)=>n&&r instanceof Blob?a?f(r):i(r,f):o&&(r instanceof ArrayBuffer||c(r))?a?f(r):i(new Blob([r]),f):f(e.PACKET_TYPES[t]+(r||""));r.encodePacket=f;const i=(e,t)=>{const n=new FileReader;return n.onload=function(){const e=n.result.split(",")[1];t("b"+(e||""))},n.readAsDataURL(e)};function u(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}let d;return r}();Object.defineProperty(e,"encodePacket",{enumerable:!0,get:function(){return n.encodePacket}});const o=s();Object.defineProperty(e,"decodePacket",{enumerable:!0,get:function(){return o.decodePacket}});const c=a(),f=String.fromCharCode(30);e.encodePayload=(e,t)=>{const r=e.length,o=new Array(r);let a=0;e.forEach(((e,c)=>{(0,n.encodePacket)(e,!1,(e=>{o[c]=e,++a===r&&t(o.join(f))}))}))};let i;function u(e){return e.reduce(((e,t)=>e+t.length),0)}function d(e,t){if(e[0].length===t)return e.shift();const n=new Uint8Array(t);let r=0;for(let o=0;o<t;o++)n[o]=e[0][r++],r===e[0].length&&(e.shift(),r=0);return e.length&&r<e[0].length&&(e[0]=e[0].slice(r)),n}e.decodePayload=(e,t)=>{const n=e.split(f),r=[];for(let a=0;a<n.length;a++){const e=(0,o.decodePacket)(n[a],t);if(r.push(e),"error"===e.type)break}return r},e.protocol=4}(n)),n}export{l as r};
